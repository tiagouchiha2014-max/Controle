<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Chuva ‚Ä¢ Fazendas e Talh√µes</title>
  <style>
    :root { --bg:#0b1220; --card:#111b33; --txt:#e8eefc; --muted:#b7c3e6; --ok:#3ddc97; --warn:#ffcc66; --bad:#ff6b6b; --b:#223159; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071022,#0b1220);color:var(--txt)}
    header{padding:20px 16px 10px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-size:22px}
    p{margin:0;color:var(--muted);font-size:13px}
    main{max-width:1100px;margin:0 auto;padding:12px 16px 30px;display:grid;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:rgba(17,27,51,.9);border:1px solid var(--b);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .span6{grid-column:span 6}
    .span12{grid-column:span 12}
    @media (max-width:900px){ .span6{grid-column:span 12} }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button,textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--b);
      background:#0c1530;color:var(--txt);outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:#3b63ff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:520px){ .row,.row3{grid-template-columns:1fr} }
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer}
    .primary{background:#2f5bff;border-color:#2f5bff}
    .ghost{background:transparent}
    .danger{background:#ff4d4d;border-color:#ff4d4d}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }
    .kpi{padding:12px;border-radius:14px;border:1px solid var(--b);background:#0c1530}
    .kpi .v{font-size:22px;font-weight:700;margin-top:4px}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--b);color:var(--muted)}
    .tag.ok{color:#052014;background:var(--ok);border-color:var(--ok)}
    .tag.warn{color:#2a1a00;background:var(--warn);border-color:var(--warn)}
    .tag.bad{color:#2a0000;background:var(--bad);border-color:var(--bad)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--b);font-size:13px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:220px;border-radius:14px;border:1px solid var(--b);background:#0c1530}
    .note{font-size:12px;color:var(--muted);line-height:1.4}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#0c1530;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <h1>üåßÔ∏è Controle de Chuva</h1>
  <p>Agora com Fazendas + Talh√µes, sincroniza√ß√£o autom√°tica e atualiza√ß√£o em tempo real.</p>
</header>

<main>
  <section class="grid">
    <div class="card span6">
      <div class="flex">
        <span class="tag" id="statusTag">Sem alerta</span>
        <span class="small" id="lastSave">‚Äî</span>
        <span class="pill" id="scopePill">‚Äî</span>
      </div>

      <!-- LOGIN -->
      <label>Login (para sincronizar entre aparelhos)</label>
      <div class="row">
        <input id="email" type="email" placeholder="seuemail@exemplo.com" />
        <button id="btnLogin" class="ghost">Enviar link</button>
      </div>
      <div class="btns">
        <button id="btnLogout" class="ghost">Sair</button>
        <button id="btnSync" class="ghost">Sincronizar agora</button>
      </div>
      <div class="small" id="authState">Deslogado</div>
      <div class="small" id="syncState">Sync: ‚Äî</div>

      <hr style="border:0;border-top:1px solid var(--b);margin:14px 0">

      <!-- FAZENDA / TALH√ÉO -->
      <label>Fazenda</label>
      <div class="row">
        <select id="farmSelect"></select>
        <button id="btnFarmManage" class="ghost">Gerenciar fazendas</button>
      </div>

      <label>Talh√£o</label>
      <div class="row">
        <select id="plotSelect"></select>
        <button id="btnPlotManage" class="ghost">Gerenciar talh√µes</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--b);margin:14px 0">

      <label>Data e hora</label>
      <input id="dt" type="datetime-local" />

      <div class="row">
        <div>
          <label>Chuva (mm)</label>
          <input id="mm" type="number" step="0.1" min="0" placeholder="Ex: 12.5" />
        </div>
        <div>
          <label>Local / Esta√ß√£o</label>
          <input id="station" type="text" placeholder="Ex: Pluvi√¥metro Quintal" />
        </div>
      </div>

      <label>Observa√ß√£o</label>
      <textarea id="obs" rows="2" placeholder="Ex: chuva forte 20min"></textarea>

      <div class="btns">
        <button class="primary" id="btnAdd">Salvar registro</button>
        <button class="ghost" id="btnClearForm">Limpar</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--b);margin:14px 0">

      <div class="row3">
        <div>
          <label>Limite alerta di√°rio (mm)</label>
          <input id="limitDaily" type="number" step="0.1" min="0" />
        </div>
        <div>
          <label>Limite alerta por hora (mm)</label>
          <input id="limitHour" type="number" step="0.1" min="0" />
        </div>
        <div>
          <label>Notifica√ß√µes</label>
          <button id="btnNotify" class="ghost">Ativar</button>
          <div class="small" id="notifyState">Desativado</div>
        </div>
      </div>

      <div class="btns">
        <button id="btnExport" class="ghost">Exportar CSV</button>
        <button id="btnBackup" class="ghost">Baixar backup (JSON)</button>
        <button id="btnImport" class="ghost">Importar JSON</button>
        <button id="btnWipe" class="danger">Apagar tudo</button>
      </div>

      <div class="note" style="margin-top:10px">
        Offline-first: salva localmente e sincroniza automaticamente quando poss√≠vel.
      </div>
      <input id="filePick" type="file" accept="application/json" style="display:none" />
    </div>

    <div class="card span6">
      <div class="kpis">
        <div class="kpi">
          <div class="small">Total hoje</div>
          <div class="v" id="kpiToday">0.0 mm</div>
        </div>
        <div class="kpi">
          <div class="small">√öltima 1 hora</div>
          <div class="v" id="kpiHour">0.0 mm</div>
        </div>
        <div class="kpi">
          <div class="small">Total m√™s</div>
          <div class="v" id="kpiMonth">0.0 mm</div>
        </div>
      </div>

      <label>Filtro</label>
      <div class="row">
        <select id="filterRange">
          <option value="7">√öltimos 7 dias</option>
          <option value="14">√öltimos 14 dias</option>
          <option value="30" selected>√öltimos 30 dias</option>
          <option value="90">√öltimos 90 dias</option>
          <option value="all">Tudo</option>
        </select>
        <input id="search" placeholder="Buscar por local/observa√ß√£o..." />
      </div>

      <label>Gr√°fico (mm por dia ‚Ä¢ talh√£o selecionado)</label>
      <canvas id="chart" width="900" height="300"></canvas>
      <div class="small">Cada barra = soma do dia no per√≠odo (fazenda/talh√£o atuais).</div>
    </div>

    <div class="card span12">
      <div class="flex" style="justify-content:space-between">
        <div>
          <strong>Hist√≥rico (fazenda/talh√£o atuais)</strong>
          <div class="small" id="countInfo">0 registros</div>
        </div>
        <div class="flex">
          <button class="ghost" id="btnSort">Ordenar: mais recentes</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Data/hora</th>
            <th>mm</th>
            <th>Fazenda</th>
            <th>Talh√£o</th>
            <th>Local</th>
            <th>Obs.</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  /***********************
   *  SUPABASE CONFIG
   ***********************/
  const SUPABASE_URL = "https://nplvnisfdhdcxynxpwll.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Gp4M0oxslUtmjtSC5i3gCQ_nILxwnqs";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /***********************
   *  STORAGE (LOCAL)
   ***********************/
  const KEY_READ = "rain_readings_v3";
  const KEY_FARMS = "rain_farms_v1";
  const KEY_PLOTS = "rain_plots_v1";
  const KEY_CFG   = "rain_cfg_v3";
  const KEY_QUEUE = "rain_queue_v3";

  function safeParse(k, fallback){
    try { return JSON.parse(localStorage.getItem(k)) ?? fallback; }
    catch { return fallback; }
  }
  function safeSave(k, v){
    localStorage.setItem(k, JSON.stringify(v));
    document.getElementById("lastSave").textContent = "Salvo: " + new Date().toLocaleString();
  }

  let readings = safeParse(KEY_READ, []);
  let farms    = safeParse(KEY_FARMS, []);
  let plots    = safeParse(KEY_PLOTS, []);
  let cfg      = safeParse(KEY_CFG, { limitDaily:50, limitHour:20, sort:"desc", farmId:"", plotId:"" });
  let queue    = safeParse(KEY_QUEUE, {
    upserts: { farms:[], plots:[], readings:[] },
    deletes: { farms:[], plots:[], readings:[] }
  });

  function saveAll(){
    safeSave(KEY_READ, readings);
    safeSave(KEY_FARMS, farms);
    safeSave(KEY_PLOTS, plots);
    safeSave(KEY_CFG, cfg);
    localStorage.setItem(KEY_QUEUE, JSON.stringify(queue));
  }

  /***********************
   *  UTILS
   ***********************/
  const pad2 = n => String(n).padStart(2,"0");
  const sum = arr => arr.reduce((s,x)=>s+x,0);
  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : (String(Date.now()) + Math.random().toString(16).slice(2)));

  function toLocalInputValue(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function parseLocalInput(v){
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }
  function ymd(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function sameDay(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function escapeHtml(s){
    return (s+"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  /***********************
   *  DOM
   ***********************/
  const elDt = document.getElementById("dt");
  const elMm = document.getElementById("mm");
  const elStation = document.getElementById("station");
  const elObs = document.getElementById("obs");
  const elTbody = document.getElementById("tbody");
  const elCountInfo = document.getElementById("countInfo");
  const elRange = document.getElementById("filterRange");
  const elSearch = document.getElementById("search");
  const elKpiToday = document.getElementById("kpiToday");
  const elKpiHour = document.getElementById("kpiHour");
  const elKpiMonth = document.getElementById("kpiMonth");
  const elTag = document.getElementById("statusTag");
  const elLimitDaily = document.getElementById("limitDaily");
  const elLimitHour = document.getElementById("limitHour");
  const elNotifyBtn = document.getElementById("btnNotify");
  const elNotifyState = document.getElementById("notifyState");
  const elAuthState = document.getElementById("authState");
  const elSyncState = document.getElementById("syncState");
  const elScopePill = document.getElementById("scopePill");

  const farmSelect = document.getElementById("farmSelect");
  const plotSelect = document.getElementById("plotSelect");

  elDt.value = toLocalInputValue(new Date());
  elLimitDaily.value = cfg.limitDaily;
  elLimitHour.value = cfg.limitHour;

  function setSyncState(msg){ elSyncState.textContent = "Sync: " + msg; }

  /***********************
   *  CHART
   ***********************/
  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");

  function drawChart(dailyPairs){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const W = canvas.width, H = canvas.height;
    const pad = 28;
    const baseY = H - pad;
    const baseX = pad;

    ctx.lineWidth = 1;
    ctx.strokeStyle = "#223159";
    ctx.beginPath();
    ctx.moveTo(baseX, pad);
    ctx.lineTo(baseX, baseY);
    ctx.lineTo(W-pad, baseY);
    ctx.stroke();

    if(!dailyPairs.length){
      ctx.fillStyle="#b7c3e6";
      ctx.font="14px system-ui";
      ctx.fillText("Sem dados no per√≠odo.", baseX+12, pad+18);
      return;
    }

    const max = Math.max(...dailyPairs.map(x=>x.mm), 5);
    const barW = Math.max(6, Math.floor((W - pad*2) / dailyPairs.length) - 2);

    ctx.fillStyle="#b7c3e6";
    ctx.font="12px system-ui";
    for(let i=0;i<=4;i++){
      const v = (max/4)*i;
      const y = baseY - ((baseY-pad)*(v/max));
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      ctx.moveTo(baseX, y);
      ctx.lineTo(W-pad, y);
      ctx.stroke();
      ctx.globalAlpha = 1;
      ctx.fillText(v.toFixed(0)+"mm", 4, y+4);
    }

    dailyPairs.forEach((p,i)=>{
      const h = ((baseY-pad)*(p.mm/max));
      const x = baseX + 2 + i*(barW+2);
      const y = baseY - h;
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "#2f5bff";
      ctx.fillRect(x,y,barW,h);

      if(dailyPairs.length <= 14 || i % Math.ceil(dailyPairs.length/10) === 0){
        ctx.globalAlpha = 1;
        ctx.fillStyle = "#b7c3e6";
        ctx.font="11px system-ui";
        ctx.save();
        ctx.translate(x+barW/2, baseY+14);
        ctx.rotate(-Math.PI/6);
        ctx.textAlign="center";
        ctx.fillText(p.day.slice(5), 0, 0);
        ctx.restore();
      }
    });

    ctx.globalAlpha = 1;
  }

  /***********************
   *  AUTH
   ***********************/
  async function getUser(){
    const { data, error } = await sb.auth.getUser();
    if(error) return null;
    return data?.user ?? null;
  }

  async function refreshAuthUI(){
    const { data: { session } } = await sb.auth.getSession();
    if(session?.user){
      elAuthState.textContent = "Logado: " + session.user.email;
      setSyncState("Pronto. Sync autom√°tico ativo.");
    }else{
      elAuthState.textContent = "Deslogado";
      setSyncState("‚Äî");
    }
  }

  document.getElementById("btnLogin").addEventListener("click", async ()=>{
    const email = document.getElementById("email").value.trim();
    if(!email) return alert("Informe seu email.");

    try{
      // use sua URL do GitHub Pages aqui:
      const redirectTo = window.location.origin + window.location.pathname;
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectTo }
      });
      if(error) throw error;
      alert("Enviei um link de login para seu email. Abra e confirme.");
    }catch(e){
      alert("Falha ao enviar link: " + (e?.message || e));
    }
  });

  document.getElementById("btnLogout").addEventListener("click", async ()=>{
    await sb.auth.signOut();
  });

  document.getElementById("btnSync").addEventListener("click", async ()=>{
    await syncNow({ pullAfter:true });
  });

  /***********************
   *  QUEUE (offline)
   ***********************/
  function qUpsert(kind, item){
    queue.upserts[kind] = queue.upserts[kind].filter(x => x.id !== item.id);
    queue.upserts[kind].push(item);
    queue.deletes[kind] = queue.deletes[kind].filter(id => id !== item.id);
    localStorage.setItem(KEY_QUEUE, JSON.stringify(queue));
  }
  function qDelete(kind, id){
    queue.upserts[kind] = queue.upserts[kind].filter(x => x.id !== id);
    if(!queue.deletes[kind].includes(id)) queue.deletes[kind].push(id);
    localStorage.setItem(KEY_QUEUE, JSON.stringify(queue));
  }

  /***********************
   *  CLOUD CRUD
   ***********************/
  async function loadCloud(kind){
    const user = await getUser();
    if(!user) return null;

    if(kind === "farms"){
      const { data, error } = await sb.from("farms").select("id,name").order("created_at",{ascending:true});
      if(error) throw error;
      return (data||[]).map(x=>({id:x.id, name:x.name}));
    }
    if(kind === "plots"){
      const { data, error } = await sb.from("plots").select("id,farm_id,name").order("created_at",{ascending:true});
      if(error) throw error;
      return (data||[]).map(x=>({id:x.id, farm_id:x.farm_id, name:x.name}));
    }
    // readings
    const { data, error } = await sb
      .from("rain_readings")
      .select("id,ts,mm,station,obs,farm_id,plot_id")
      .order("ts",{ascending:false});
    if(error) throw error;
    return (data||[]).map(x=>({
      id:x.id, ts:Number(x.ts), mm:Number(x.mm),
      station:x.station||"", obs:x.obs||"",
      farm_id:x.farm_id, plot_id:x.plot_id
    }));
  }

  async function upsertCloud(kind, items){
    const user = await getUser();
    if(!user) return false;

    if(kind === "farms"){
      const payload = items.map(it=>({ id:it.id, user_id:user.id, name:it.name }));
      const { error } = await sb.from("farms").upsert(payload,{onConflict:"id"});
      if(error) throw error;
      return true;
    }
    if(kind === "plots"){
      const payload = items.map(it=>({ id:it.id, user_id:user.id, farm_id:it.farm_id, name:it.name }));
      const { error } = await sb.from("plots").upsert(payload,{onConflict:"id"});
      if(error) throw error;
      return true;
    }

    // readings
    const payload = items.map(it=>({
      id:it.id, user_id:user.id, ts:it.ts, mm:it.mm,
      station:it.station||"", obs:it.obs||"",
      farm_id:it.farm_id, plot_id:it.plot_id
    }));
    const { error } = await sb.from("rain_readings").upsert(payload,{onConflict:"id"});
    if(error) throw error;
    return true;
  }

  async function deleteCloud(kind, ids){
    const user = await getUser();
    if(!user) return false;
    if(!ids.length) return true;

    const table = (kind==="farms") ? "farms" : (kind==="plots" ? "plots" : "rain_readings");
    const { error } = await sb.from(table).delete().in("id", ids).eq("user_id", user.id);
    if(error) throw error;
    return true;
  }

  /***********************
   *  SYNC ENGINE
   ***********************/
  let syncing = false;
  let syncTimer = null;

  function scheduleSync(delayMs=800){
    clearTimeout(syncTimer);
    syncTimer = setTimeout(()=>syncNow({pullAfter:true}).catch(()=>{}), delayMs);
  }

  async function syncNow({pullAfter=true} = {}){
    if(syncing) return;
    if(!navigator.onLine){
      setSyncState("Offline. Vou sincronizar quando voltar.");
      return;
    }

    const user = await getUser();
    if(!user){
      setSyncState("Fa√ßa login para sincronizar.");
      return;
    }

    syncing = true;
    try{
      const q = safeParse(KEY_QUEUE, queue);
      const hasPending =
        (q.upserts.farms.length||q.deletes.farms.length||
         q.upserts.plots.length||q.deletes.plots.length||
         q.upserts.readings.length||q.deletes.readings.length);

      if(hasPending){
        setSyncState(`Enviando... (F:${q.upserts.farms.length}/${q.deletes.farms.length} ‚Ä¢ T:${q.upserts.plots.length}/${q.deletes.plots.length} ‚Ä¢ R:${q.upserts.readings.length}/${q.deletes.readings.length})`);

        // ORDEM IMPORTA (para n√£o quebrar FK):
        // 1) upsert farms, 2) upsert plots, 3) upsert readings
        if(q.upserts.farms.length) await upsertCloud("farms", q.upserts.farms);
        if(q.upserts.plots.length) await upsertCloud("plots", q.upserts.plots);
        if(q.upserts.readings.length) await upsertCloud("readings", q.upserts.readings);

        // deletes inverso: readings -> plots -> farms
        if(q.deletes.readings.length) await deleteCloud("readings", q.deletes.readings);
        if(q.deletes.plots.length) await deleteCloud("plots", q.deletes.plots);
        if(q.deletes.farms.length) await deleteCloud("farms", q.deletes.farms);

        queue = { upserts:{farms:[],plots:[],readings:[]}, deletes:{farms:[],plots:[],readings:[]} };
        localStorage.setItem(KEY_QUEUE, JSON.stringify(queue));
      }

      if(pullAfter){
        const [cf, cp, cr] = await Promise.all([
          loadCloud("farms"),
          loadCloud("plots"),
          loadCloud("readings")
        ]);
        if(cf){ farms = cf; safeSave(KEY_FARMS, farms); }
        if(cp){ plots = cp; safeSave(KEY_PLOTS, plots); }
        if(cr){ readings = cr; safeSave(KEY_READ, readings); }
      }

      setSyncState("Sincronizado ‚úÖ");
      ensureScopeDefaults();
      renderSelectors();
      render();
    }catch(e){
      console.log(e);
      setSyncState("Falhou (erro). Mantive na fila.");
    } finally {
      syncing = false;
    }
  }

  /***********************
   *  REALTIME
   ***********************/
  let realtimeSub = null;

  async function startRealtime(){
    const user = await getUser();
    if(!user) return;
    if(realtimeSub) return;

    realtimeSub = sb.channel("rain_realtime_all")
      .on("postgres_changes", {event:"*", schema:"public", table:"farms", filter:`user_id=eq.${user.id}`}, ()=>scheduleSync(250))
      .on("postgres_changes", {event:"*", schema:"public", table:"plots", filter:`user_id=eq.${user.id}`}, ()=>scheduleSync(250))
      .on("postgres_changes", {event:"*", schema:"public", table:"rain_readings", filter:`user_id=eq.${user.id}`}, ()=>scheduleSync(250))
      .subscribe();
  }

  async function stopRealtime(){
    if(realtimeSub){
      try{ await sb.removeChannel(realtimeSub); }catch(e){}
      realtimeSub = null;
    }
  }

  sb.auth.onAuthStateChange(async (_event, session)=>{
    if(session?.user){
      elAuthState.textContent = "Logado: " + session.user.email;
      await startRealtime();
      scheduleSync(100);
    }else{
      elAuthState.textContent = "Deslogado";
      await stopRealtime();
    }
  });

  /***********************
   *  FAZENDA/TALH√ÉO: SELECTORS + CRUD
   ***********************/
  function ensureScopeDefaults(){
    // se n√£o houver nada, n√£o for√ßa
    if(farms.length && !cfg.farmId) cfg.farmId = farms[0].id;

    const plotsInFarm = plots.filter(p=>p.farm_id === cfg.farmId);
    if(plotsInFarm.length && !plotsInFarm.some(p=>p.id===cfg.plotId)){
      cfg.plotId = plotsInFarm[0].id;
    }
    safeSave(KEY_CFG, cfg);
  }

  function renderSelectors(){
    // farms
    farmSelect.innerHTML = "";
    if(!farms.length){
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = "Nenhuma fazenda (crie uma)";
      farmSelect.appendChild(opt);
    }else{
      farms.forEach(f=>{
        const opt = document.createElement("option");
        opt.value = f.id; opt.textContent = f.name;
        farmSelect.appendChild(opt);
      });
    }
    farmSelect.value = cfg.farmId || (farms[0]?.id || "");

    // plots
    const fId = farmSelect.value;
    const inFarm = plots.filter(p=>p.farm_id === fId);
    plotSelect.innerHTML = "";
    if(!inFarm.length){
      const opt = document.createElement("option");
      opt.value=""; opt.textContent = "Nenhum talh√£o (crie um)";
      plotSelect.appendChild(opt);
    }else{
      inFarm.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = p.name;
        plotSelect.appendChild(opt);
      });
    }
    // define plot atual
    if(inFarm.length){
      if(!cfg.plotId || !inFarm.some(p=>p.id===cfg.plotId)) cfg.plotId = inFarm[0].id;
      plotSelect.value = cfg.plotId;
    }else{
      cfg.plotId = "";
      plotSelect.value = "";
    }
    safeSave(KEY_CFG, cfg);

    // pill
    const fName = farms.find(x=>x.id===cfg.farmId)?.name || "Sem fazenda";
    const pName = plots.find(x=>x.id===cfg.plotId)?.name || "Sem talh√£o";
    elScopePill.textContent = `${fName} ‚Ä¢ ${pName}`;
  }

  farmSelect.addEventListener("change", ()=>{
    cfg.farmId = farmSelect.value;
    cfg.plotId = ""; // reseta e escolhe o primeiro do novo farm
    safeSave(KEY_CFG, cfg);
    ensureScopeDefaults();
    renderSelectors();
    render();
  });

  plotSelect.addEventListener("change", ()=>{
    cfg.plotId = plotSelect.value;
    safeSave(KEY_CFG, cfg);
    renderSelectors();
    render();
  });

  function promptMenu(title, options){
    const txt = options.map((o,i)=>`${i+1}) ${o}`).join("\n");
    const ans = prompt(`${title}\n\n${txt}\n\nDigite o n√∫mero:`);
    const n = Number(ans);
    if(!n || n<1 || n>options.length) return null;
    return n;
  }

  document.getElementById("btnFarmManage").addEventListener("click", ()=>{
    const choice = promptMenu("Gerenciar Fazendas", ["Adicionar", "Renomear", "Excluir"]);
    if(!choice) return;

    if(choice===1){
      const name = prompt("Nome da fazenda:");
      if(!name) return;
      const f = { id: uuid(), name: name.trim() };
      farms.push(f);
      safeSave(KEY_FARMS, farms);
      qUpsert("farms", f);
      if(!cfg.farmId) cfg.farmId = f.id;
      safeSave(KEY_CFG, cfg);
      renderSelectors();
      render();
      scheduleSync(400);
      return;
    }

    if(!farms.length) return alert("Nenhuma fazenda para editar.");
    const current = farms.find(x=>x.id===cfg.farmId) || farms[0];

    if(choice===2){
      const name = prompt("Novo nome:", current.name);
      if(!name) return;
      current.name = name.trim();
      safeSave(KEY_FARMS, farms);
      qUpsert("farms", current);
      renderSelectors();
      render();
      scheduleSync(400);
      return;
    }

    // excluir fazenda (tamb√©m remove talh√µes e leituras localmente; cloud vai respeitar FK e deletar por cascade em plots)
    if(choice===3){
      if(!confirm(`Excluir fazenda "${current.name}"? Isso remove os talh√µes e registros relacionados.`)) return;

      const farmId = current.id;

      // ids locais relacionados
      const plotIds = plots.filter(p=>p.farm_id===farmId).map(p=>p.id);
      const readingIds = readings.filter(r=>r.farm_id===farmId).map(r=>r.id);

      // remove local
      farms = farms.filter(f=>f.id!==farmId);
      plots = plots.filter(p=>p.farm_id!==farmId);
      readings = readings.filter(r=>r.farm_id!==farmId);

      safeSave(KEY_FARMS, farms);
      safeSave(KEY_PLOTS, plots);
      safeSave(KEY_READ, readings);

      // fila deletar (ordem)
      readingIds.forEach(id=>qDelete("readings", id));
      plotIds.forEach(id=>qDelete("plots", id));
      qDelete("farms", farmId);

      // ajusta scope
      cfg.farmId = farms[0]?.id || "";
      cfg.plotId = "";
      safeSave(KEY_CFG, cfg);
      ensureScopeDefaults();
      renderSelectors();
      render();
      scheduleSync(400);
    }
  });

  document.getElementById("btnPlotManage").addEventListener("click", ()=>{
    if(!cfg.farmId) return alert("Crie/Selecione uma fazenda primeiro.");

    const choice = promptMenu("Gerenciar Talh√µes", ["Adicionar", "Renomear", "Excluir"]);
    if(!choice) return;

    const inFarm = plots.filter(p=>p.farm_id===cfg.farmId);

    if(choice===1){
      const name = prompt("Nome do talh√£o:");
      if(!name) return;
      const p = { id: uuid(), farm_id: cfg.farmId, name: name.trim() };
      plots.push(p);
      safeSave(KEY_PLOTS, plots);
      qUpsert("plots", p);
      cfg.plotId = p.id;
      safeSave(KEY_CFG, cfg);
      renderSelectors();
      render();
      scheduleSync(400);
      return;
    }

    if(!inFarm.length) return alert("Nenhum talh√£o para editar nesta fazenda.");
    const current = inFarm.find(x=>x.id===cfg.plotId) || inFarm[0];

    if(choice===2){
      const name = prompt("Novo nome:", current.name);
      if(!name) return;
      current.name = name.trim();
      safeSave(KEY_PLOTS, plots);
      qUpsert("plots", current);
      renderSelectors();
      render();
      scheduleSync(400);
      return;
    }

    if(choice===3){
      if(!confirm(`Excluir talh√£o "${current.name}"? Isso remove os registros relacionados.`)) return;
      const plotId = current.id;
      const readingIds = readings.filter(r=>r.plot_id===plotId).map(r=>r.id);

      plots = plots.filter(p=>p.id!==plotId);
      readings = readings.filter(r=>r.plot_id!==plotId);

      safeSave(KEY_PLOTS, plots);
      safeSave(KEY_READ, readings);

      readingIds.forEach(id=>qDelete("readings", id));
      qDelete("plots", plotId);

      cfg.plotId = "";
      safeSave(KEY_CFG, cfg);
      ensureScopeDefaults();
      renderSelectors();
      render();
      scheduleSync(400);
    }
  });

  /***********************
   *  FILTER + KPIs
   ***********************/
  function getFiltered(){
    const q = (elSearch.value||"").toLowerCase().trim();
    const range = elRange.value;

    let arr = readings.filter(r => r.farm_id===cfg.farmId && r.plot_id===cfg.plotId);

    arr.sort((a,b)=> cfg.sort==="desc" ? (b.ts-a.ts) : (a.ts-b.ts));

    if(range !== "all"){
      const days = Number(range);
      const since = Date.now() - days*24*3600*1000;
      arr = arr.filter(x => x.ts >= since);
    }

    if(q){
      arr = arr.filter(x =>
        (x.station||"").toLowerCase().includes(q) ||
        (x.obs||"").toLowerCase().includes(q)
      );
    }
    return arr;
  }

  function computeKPIs(){
    const now = new Date();
    const scope = readings.filter(r => r.farm_id===cfg.farmId && r.plot_id===cfg.plotId);

    const todaySum = sum(scope.filter(x => sameDay(new Date(x.ts), now)).map(x => Number(x.mm)||0));
    const hourAgo = Date.now() - 3600*1000;
    const hourSum = sum(scope.filter(x => x.ts >= hourAgo).map(x => Number(x.mm)||0));
    const monthSum = sum(scope.filter(x => {
      const d = new Date(x.ts);
      return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();
    }).map(x => Number(x.mm)||0));

    elKpiToday.textContent = todaySum.toFixed(1) + " mm";
    elKpiHour.textContent  = hourSum.toFixed(1) + " mm";
    elKpiMonth.textContent = monthSum.toFixed(1) + " mm";

    const daily = Number(cfg.limitDaily)||0;
    const hourly = Number(cfg.limitHour)||0;

    let level="ok", text="Sem alerta";
    if(daily>0 && todaySum >= daily){ level="bad"; text="Alerta di√°rio"; }
    else if(hourly>0 && hourSum >= hourly){ level="warn"; text="Alerta 1h"; }

    elTag.className = "tag " + level;
    elTag.textContent = text;

    return {level, todaySum, hourSum};
  }

  function computeDailyBars(filtered){
    const map = new Map();
    filtered.forEach(x=>{
      const d = new Date(x.ts);
      const key = ymd(d);
      map.set(key, (map.get(key)||0) + (Number(x.mm)||0));
    });
    return [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0])).map(([day,mm])=>({day,mm}));
  }

  /***********************
   *  NOTIFICATIONS
   ***********************/
  let notifiedKey = "";
  async function enableNotify(){
    if(!("Notification" in window)){
      elNotifyState.textContent = "N√£o suportado";
      return;
    }
    const perm = await Notification.requestPermission();
    elNotifyState.textContent = (perm==="granted") ? "Ativado" : "Bloqueado";
  }
  function maybeNotify(k){
    if(!("Notification" in window)) return;
    if(Notification.permission !== "granted") return;
    if(k.level==="ok"){ notifiedKey=""; return; }

    const today = ymd(new Date());
    const key = `${today}:${cfg.farmId}:${cfg.plotId}:${k.level}:${cfg.limitDaily}:${cfg.limitHour}`;
    if(key===notifiedKey) return;

    const msg = (k.level==="bad")
      ? `A chuva de hoje chegou a ${k.todaySum.toFixed(1)}mm (limite ${cfg.limitDaily}mm).`
      : `Na √∫ltima 1 hora: ${k.hourSum.toFixed(1)}mm (limite ${cfg.limitHour}mm).`;

    new Notification("Controle de Chuva", { body: msg });
    notifiedKey = key;
  }

  /***********************
   *  RENDER
   ***********************/
  function render(){
    renderSelectors();

    const filtered = getFiltered();
    elCountInfo.textContent = `${filtered.length} registro(s) ‚Ä¢ ${readings.length} total (todas fazendas)`;

    elTbody.innerHTML = "";
    filtered.forEach(item=>{
      const tr = document.createElement("tr");
      const d = new Date(item.ts);

      const fName = farms.find(x=>x.id===item.farm_id)?.name || "‚Äî";
      const pName = plots.find(x=>x.id===item.plot_id)?.name || "‚Äî";

      tr.innerHTML = `
        <td>${d.toLocaleString()}</td>
        <td><strong>${Number(item.mm).toFixed(1)}</strong></td>
        <td>${escapeHtml(fName)}</td>
        <td>${escapeHtml(pName)}</td>
        <td>${escapeHtml(item.station||"‚Äî")}</td>
        <td>${escapeHtml(item.obs||"")}</td>
        <td><button class="ghost" data-del="${item.id}">Excluir</button></td>
      `;
      elTbody.appendChild(tr);
    });

    const bars = computeDailyBars(filtered);
    drawChart(bars);

    const k = computeKPIs();
    maybeNotify(k);
  }

  /***********************
   *  ACTIONS
   ***********************/
  document.getElementById("btnAdd").addEventListener("click", ()=>{
    if(!cfg.farmId) return alert("Crie uma fazenda primeiro.");
    if(!cfg.plotId) return alert("Crie um talh√£o primeiro.");

    const d = parseLocalInput(elDt.value);
    const mm = Number(elMm.value);
    if(!d) return alert("Data/hora inv√°lida.");
    if(!(mm >= 0)) return alert("Informe mm (>= 0).");

    const item = {
      id: uuid(),
      ts: d.getTime(),
      mm: Number(mm.toFixed(1)),
      station: (elStation.value||"").trim(),
      obs: (elObs.value||"").trim(),
      farm_id: cfg.farmId,
      plot_id: cfg.plotId
    };

    readings.push(item);
    safeSave(KEY_READ, readings);
    qUpsert("readings", item);

    setSyncState("Salvo local. Sync autom√°tico...");
    scheduleSync(600);

    elMm.value = "";
    elObs.value = "";
    elDt.value = toLocalInputValue(new Date());
    render();
  });

  document.getElementById("btnClearForm").addEventListener("click", ()=>{
    elMm.value = "";
    elObs.value = "";
    elStation.value = "";
    elDt.value = toLocalInputValue(new Date());
  });

  document.getElementById("btnSort").addEventListener("click", ()=>{
    cfg.sort = (cfg.sort==="desc") ? "asc" : "desc";
    safeSave(KEY_CFG, cfg);
    document.getElementById("btnSort").textContent = "Ordenar: " + (cfg.sort==="desc" ? "mais recentes" : "mais antigos");
    render();
  });

  elRange.addEventListener("change", render);
  elSearch.addEventListener("input", render);

  elLimitDaily.addEventListener("input", ()=>{
    cfg.limitDaily = Number(elLimitDaily.value)||0;
    safeSave(KEY_CFG, cfg);
    render();
  });
  elLimitHour.addEventListener("input", ()=>{
    cfg.limitHour = Number(elLimitHour.value)||0;
    safeSave(KEY_CFG, cfg);
    render();
  });

  elNotifyBtn.addEventListener("click", enableNotify);

  elTbody.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-del]");
    if(!btn) return;
    const id = btn.getAttribute("data-del");

    readings = readings.filter(x=>x.id !== id);
    safeSave(KEY_READ, readings);

    qDelete("readings", id);
    setSyncState("Exclus√£o pendente. Sync autom√°tico...");
    scheduleSync(600);
    render();
  });

  // Export CSV (somente escopo atual)
  document.getElementById("btnExport").addEventListener("click", ()=>{
    const fName = farms.find(x=>x.id===cfg.farmId)?.name || "fazenda";
    const pName = plots.find(x=>x.id===cfg.plotId)?.name || "talhao";
    const rows = [["datetime","mm","farm","plot","station","obs"]];
    readings
      .filter(r=>r.farm_id===cfg.farmId && r.plot_id===cfg.plotId)
      .slice().sort((a,b)=>a.ts-b.ts)
      .forEach(x=>{
        rows.push([new Date(x.ts).toISOString(), x.mm, fName, pName, x.station||"", x.obs||""]);
      });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    downloadText(`chuva-${fName}-${pName}.csv`.replaceAll(" ","_"), csv);
  });

  // Backup JSON (tudo)
  document.getElementById("btnBackup").addEventListener("click", ()=>{
    const backup = { version:3, exportedAt:new Date().toISOString(), cfg, farms, plots, readings, queue: safeParse(KEY_QUEUE, queue) };
    downloadText("backup-chuva-v3.json", JSON.stringify(backup,null,2));
  });

  // Import JSON
  const filePick = document.getElementById("filePick");
  document.getElementById("btnImport").addEventListener("click", ()=>{ filePick.value=""; filePick.click(); });
  filePick.addEventListener("change", async ()=>{
    const file = filePick.files?.[0];
    if(!file) return;
    try{
      const obj = JSON.parse(await file.text());
      if(!obj || !Array.isArray(obj.readings) || !Array.isArray(obj.farms) || !Array.isArray(obj.plots)){
        throw new Error("Formato inv√°lido (esperado v3).");
      }
      farms = obj.farms; plots = obj.plots; readings = obj.readings;
      cfg = obj.cfg || cfg;
      queue = obj.queue || queue;

      saveAll();
      ensureScopeDefaults();
      renderSelectors();
      render();
      alert("Importado com sucesso!");
      scheduleSync(800);
    }catch(err){
      alert("Falha ao importar: " + err.message);
    }
  });

  // Wipe local (marca deletes)
  document.getElementById("btnWipe").addEventListener("click", ()=>{
    if(!confirm("Apagar TUDO local (fazendas, talh√µes e registros)?")) return;

    // marca deletes de tudo que existe localmente
    readings.forEach(r=>qDelete("readings", r.id));
    plots.forEach(p=>qDelete("plots", p.id));
    farms.forEach(f=>qDelete("farms", f.id));

    farms = []; plots = []; readings = [];
    cfg.farmId=""; cfg.plotId="";
    saveAll();

    renderSelectors();
    render();
    setSyncState("Tudo apagado local. Sync autom√°tico vai refletir na nuvem.");
    scheduleSync(900);
  });

  /***********************
   *  AUTO SYNC TRIGGERS
   ***********************/
  window.addEventListener("online", ()=>{ setSyncState("Internet voltou. Sync..."); scheduleSync(250); });
  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden && navigator.onLine) scheduleSync(200); });
  setInterval(()=>{ if(navigator.onLine) scheduleSync(0); }, 2*60*1000);

  /***********************
   *  INIT
   ***********************/
  document.getElementById("btnSort").textContent = "Ordenar: " + (cfg.sort==="desc" ? "mais recentes" : "mais antigos");
  elNotifyState.textContent = ("Notification" in window)
    ? (Notification.permission==="granted" ? "Ativado" : "Desativado")
    : "N√£o suportado";

  // se n√£o existir fazenda/talh√£o local, deixa o usu√°rio criar
  ensureScopeDefaults();
  renderSelectors();
  render();
  refreshAuthUI();

  // se j√° estiver logado, inicia realtime + sync
  (async ()=>{
    const { data: { session } } = await sb.auth.getSession();
    if(session?.user){
      await startRealtime();
      scheduleSync(200);
    }
  })();
</script>
</body>
</html>
